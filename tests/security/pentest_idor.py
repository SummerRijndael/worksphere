import requests

base_url = "http://localhost:8000/api"
non_admin_token = "2|cDRfKOIDQJGJR5ULTUsrmT8oPW3y88M4tWECa4HUef8ea5ef"
admin_public_id = "17152833-afb1-4327-9855-6275c122f1a6"

headers = {
    "Authorization": f"Bearer {non_admin_token}",
    "Accept": "application/json"
}

tests = [
    {"name": "List Users (Admin Only)", "url": f"{base_url}/users", "method": "GET", "expected": 403},
    {"name": "List Teams (Admin Only)", "url": f"{base_url}/teams", "method": "GET", "expected": 403},
    {"name": "View Admin Details (IDOR)", "url": f"{base_url}/users/{admin_public_id}", "method": "GET", "expected": 403},
    {"name": "Update Admin Details (IDOR)", "url": f"{base_url}/users/{admin_public_id}", "method": "PUT", "data": {"name": "Hacked"}, "expected": 403},
    {"name": "Delete Admin (IDOR)", "url": f"{base_url}/users/{admin_public_id}", "method": "DELETE", "expected": 403},
]

print("Running IDOR / Authorization Tests...")
all_passed = True

for test in tests:
    try:
        if test["method"] == "GET":
            response = requests.get(test["url"], headers=headers)
        elif test["method"] == "PUT":
            response = requests.put(test["url"], headers=headers, json=test.get("data", {}))
        elif test["method"] == "DELETE":
            response = requests.delete(test["url"], headers=headers)
        
        status = response.status_code
        if status == test["expected"]:
            print(f"✅ PASSED: {test['name']} - Got {status}")
        else:
            print(f"❌ FAILED: {test['name']} - Expected {test['expected']}, Got {status}")
            print(f"Response: {response.text[:200]}")
            all_passed = False
            
    except Exception as e:
        print(f"ERROR: {test['name']} - {e}")
        all_passed = False

if not all_passed:
    print("\n⚠️  Some Security Tests Failed!")
else:
    print("\n✅ All IDOR/Auth Tests Passed!")
