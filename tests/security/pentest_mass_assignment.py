import requests
import json

base_url = "http://localhost:8000/api"
non_admin_token = "2|cDRfKOIDQJGJR5ULTUsrmT8oPW3y88M4tWECa4HUef8ea5ef"

headers = {
    "Authorization": f"Bearer {non_admin_token}",
    "Accept": "application/json",
    "Content-Type": "application/json"
}

# 1. Get current user details
print("Fetching current profile...")
response = requests.get(f"{base_url}/user", headers=headers)
# print(f"Current Profile: {response.text}")
data = response.json()
user = data.get('user', data) # Handle wrapper if present
# Store original values for verification and reverting
original_role = user.get('roles', ['unknown'])[0]
original_name = user.get('name', 'Test User')
print(f"Original Role: {original_role}")

# 2. Attempt Mass Assignment
print("\nAttempting Mass Assignment update (Role -> administrator)...")
payload = {
    "name": "MassAssignmentTest",  # Temporary test name
    "email": user.get('email', 'member@example.com'),
    "role": "administrator", # Malicious field
    "status": "active" # Malicious field
}

response = requests.put(f"{base_url}/user/profile", headers=headers, json=payload)
print(f"Update Status: {response.status_code}")
updated_user = response.json()
# print(f"Updated Profile Response: {updated_user}")

# 3. Verify
print("\nVerifying...")
# Fetch fresh data to be sure
response = requests.get(f"{base_url}/user", headers=headers)
fresh_data = response.json()
fresh_user = fresh_data.get('user', fresh_data)
new_role = fresh_user.get('roles', ['unknown'])[0]

if new_role == original_role:
    print(f"✅ PASSED: Role is still '{new_role}'. Mass Assignment prevented.")
else:
    print(f"❌ FAILED: Role changed to '{new_role}'! Vulnerability detected.")

if fresh_user.get('name') == "MassAssignmentTest":
     print("✅ PASSED: Name was successfully updated (legitimate field).")
else:
     print(f"❌ FAILED: Name was NOT updated. Got: {fresh_user.get('name', 'N/A')}")

# 4. REVERT - Restore original name
print("\nReverting name to original...")
revert_payload = {"name": original_name, "email": user.get('email', 'member@example.com')}
requests.put(f"{base_url}/user/profile", headers=headers, json=revert_payload)
print(f"✅ Name reverted to: {original_name}")
