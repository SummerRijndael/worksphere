#!/usr/bin/env python3
"""
CSRF Protection Pentest Script
Tests for Cross-Site Request Forgery vulnerabilities
"""

import requests
import sys

base_url = "http://localhost:8000/api"

# Test tokens
admin_token = "1|rIChykfSoXL9rQ1eFpLzuLSSVlRqEuP42T2GYH6I77f4a980"

headers_with_token = {
    "Authorization": f"Bearer {admin_token}",
    "Accept": "application/json",
    "Content-Type": "application/json"
}

# Headers WITHOUT CSRF token for SPA routes
headers_no_csrf = {
    "Authorization": f"Bearer {admin_token}",
    "Accept": "application/json",
    "Content-Type": "application/json",
    "Origin": "http://evil-site.com",  # Cross-origin request
    "Referer": "http://evil-site.com/attack"
}

print("=" * 60)
print("CSRF Protection Pentest")
print("=" * 60)

all_passed = True

# Test 1: State-changing endpoint with cross-origin headers
print("\n--- Test 1: Cross-Origin POST Request ---")
try:
    response = requests.post(
        f"{base_url}/user/profile",
        headers=headers_no_csrf,
        json={"name": "CSRF Attack Test"}
    )
    
    # For API routes with Sanctum token auth, CORS should block or the request should succeed
    # since token-based auth doesn't use CSRF cookies
    if response.status_code in [200, 401, 403]:
        print(f"✅ Response: {response.status_code} - Token-based auth handled correctly")
    else:
        print(f"⚠️  Unexpected status: {response.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 2: Check CORS headers
print("\n--- Test 2: CORS Headers Validation ---")
try:
    response = requests.options(
        f"{base_url}/user",
        headers={
            "Origin": "http://evil-site.com",
            "Access-Control-Request-Method": "POST",
            "Access-Control-Request-Headers": "Authorization, Content-Type"
        }
    )
    
    cors_origin = response.headers.get("Access-Control-Allow-Origin", "")
    
    if cors_origin == "*":
        print(f"❌ FAILED: CORS allows all origins (wildcard)")
        all_passed = False
    elif "evil-site.com" in cors_origin:
        print(f"❌ FAILED: CORS allows untrusted origin: {cors_origin}")
        all_passed = False
    else:
        print(f"✅ PASSED: CORS properly restricts origin. Got: '{cors_origin}'")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 3: Session-based endpoint CSRF (Two-Factor Challenge)
print("\n--- Test 3: 2FA Challenge CSRF Protection ---")
try:
    response = requests.post(
        f"{base_url}/two-factor-challenge",
        headers={
            "Accept": "application/json",
            "Content-Type": "application/json",
            "Origin": "http://evil-site.com"
        },
        json={"code": "123456"}
    )
    
    # Should fail with 401/403/419 (CSRF token mismatch) or rate limited
    if response.status_code in [401, 403, 419, 429, 422]:
        print(f"✅ PASSED: Protected endpoint rejected request ({response.status_code})")
    else:
        print(f"⚠️  Status: {response.status_code} - Review if this is expected")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 4: Verify X-Requested-With handling
print("\n--- Test 4: XMLHttpRequest Header Validation ---")
try:
    response = requests.post(
        f"{base_url}/login",
        headers={
            "Accept": "application/json",
            "Content-Type": "application/json",
            # Missing X-Requested-With header
        },
        json={"email": "test@example.com", "password": "password"}
    )
    
    # Should still work for API (not relying on X-Requested-With)
    if response.status_code in [200, 401, 422, 429]:
        print(f"✅ Request processed: {response.status_code}")
    else:
        print(f"⚠️  Unexpected: {response.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

print("\n" + "=" * 60)
if all_passed:
    print("✅ All CSRF Protection Tests Passed!")
else:
    print("⚠️  Some CSRF Tests Need Review")
print("=" * 60)

sys.exit(0 if all_passed else 1)
