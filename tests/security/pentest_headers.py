#!/usr/bin/env python3
"""
Security Headers Pentest Script
Validates presence and configuration of security headers
"""

import requests
import sys

base_url = "http://localhost:8000"

print("=" * 60)
print("Security Headers Pentest")
print("=" * 60)

all_passed = True
token = "1|rIChykfSoXL9rQ1eFpLzuLSSVlRqEuP42T2GYH6I77f4a980"

# Define security headers to check
security_headers = {
    "X-Content-Type-Options": {
        "expected": "nosniff",
        "severity": "HIGH",
        "description": "Prevents MIME-type sniffing"
    },
    "X-Frame-Options": {
        "expected": ["DENY", "SAMEORIGIN"],
        "severity": "HIGH",
        "description": "Prevents clickjacking attacks"
    },
    "X-XSS-Protection": {
        "expected": ["1; mode=block", "0"],  # 0 is acceptable as CSP is preferred
        "severity": "LOW",
        "description": "Legacy XSS protection (deprecated)"
    },
    "Strict-Transport-Security": {
        "expected": None,  # Any value is good, check for presence
        "severity": "HIGH",
        "description": "Enforces HTTPS connections",
        "https_only": True
    },
    "Content-Security-Policy": {
        "expected": None,
        "severity": "MEDIUM",
        "description": "Prevents XSS and injection attacks"
    },
    "Referrer-Policy": {
        "expected": ["strict-origin-when-cross-origin", "no-referrer", "same-origin", "strict-origin"],
        "severity": "LOW",
        "description": "Controls referrer information"
    },
    "Permissions-Policy": {
        "expected": None,
        "severity": "LOW",
        "description": "Controls browser features"
    }
}

# Test API endpoint
print("\n--- API Response Headers ---")
try:
    response = requests.get(
        f"{base_url}/api/user",
        headers={
            "Authorization": f"Bearer {token}",
            "Accept": "application/json"
        }
    )
    
    print(f"Status: {response.status_code}\n")
    
    for header, config in security_headers.items():
        actual = response.headers.get(header)
        expected = config["expected"]
        severity = config["severity"]
        description = config["description"]
        https_only = config.get("https_only", False)
        
        # Skip HTTPS-only headers for HTTP testing
        if https_only and not base_url.startswith("https"):
            print(f"⏭️  {header}: Skipped (HTTPS only)")
            continue
        
        if actual:
            if expected is None:
                # Just checking presence
                print(f"✅ {header}: {actual}")
            elif isinstance(expected, list):
                if actual in expected:
                    print(f"✅ {header}: {actual}")
                else:
                    print(f"⚠️  {header}: {actual} (expected one of: {expected})")
            else:
                if actual == expected:
                    print(f"✅ {header}: {actual}")
                else:
                    print(f"⚠️  {header}: {actual} (expected: {expected})")
        else:
            if severity == "HIGH":
                print(f"❌ {header}: MISSING [{severity}] - {description}")
                all_passed = False
            else:
                print(f"⚠️  {header}: Missing [{severity}] - {description}")
                
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test for information disclosure headers
print("\n--- Information Disclosure Check ---")
disclosure_headers = [
    "Server",
    "X-Powered-By",
    "X-AspNet-Version",
    "X-AspNetMvc-Version",
    "X-Debug-Token",
]

try:
    response = requests.get(f"{base_url}/api/auth/config")
    
    for header in disclosure_headers:
        value = response.headers.get(header)
        if value:
            print(f"⚠️  {header}: {value} (consider removing)")
        else:
            print(f"✅ {header}: Not disclosed")
            
except Exception as e:
    print(f"ERROR: {e}")

# Test CORS headers
print("\n--- CORS Configuration ---")
try:
    # Preflight request
    response = requests.options(
        f"{base_url}/api/user",
        headers={
            "Origin": "http://localhost:5173",
            "Access-Control-Request-Method": "GET",
            "Access-Control-Request-Headers": "Authorization"
        }
    )
    
    cors_headers = [
        "Access-Control-Allow-Origin",
        "Access-Control-Allow-Methods",
        "Access-Control-Allow-Headers",
        "Access-Control-Allow-Credentials",
    ]
    
    for header in cors_headers:
        value = response.headers.get(header)
        if value:
            if header == "Access-Control-Allow-Origin" and value == "*":
                print(f"⚠️  {header}: {value} (wildcard - may be insecure with credentials)")
            else:
                print(f"ℹ️  {header}: {value}")
        else:
            print(f"ℹ️  {header}: Not set")
            
except Exception as e:
    print(f"ERROR: {e}")

# Test Cache-Control for sensitive endpoints
print("\n--- Cache-Control for Sensitive Data ---")
try:
    response = requests.get(
        f"{base_url}/api/user",
        headers={
            "Authorization": f"Bearer {token}",
            "Accept": "application/json"
        }
    )
    
    cache_control = response.headers.get("Cache-Control", "")
    
    sensitive_cache_directives = ["no-store", "no-cache", "private"]
    has_protection = any(d in cache_control.lower() for d in sensitive_cache_directives)
    
    if has_protection:
        print(f"✅ Cache-Control: {cache_control}")
    else:
        print(f"⚠️  Cache-Control: {cache_control or 'Not set'} (sensitive data may be cached)")
        
except Exception as e:
    print(f"ERROR: {e}")

print("\n" + "=" * 60)
if all_passed:
    print("✅ All Security Headers Tests Passed!")
else:
    print("⚠️  Some Security Headers Need Attention")
print("=" * 60)

sys.exit(0 if all_passed else 1)
