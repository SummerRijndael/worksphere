#!/usr/bin/env python3
"""
Authentication Security Pentest Script
Tests for authentication bypass and token security vulnerabilities
"""

import requests
import sys
import time

base_url = "http://localhost:8000/api"

# Valid token for comparison
valid_token = "1|rIChykfSoXL9rQ1eFpLzuLSSVlRqEuP42T2GYH6I77f4a980"

print("=" * 60)
print("Authentication Security Pentest")
print("=" * 60)

all_passed = True
results = []

# Test 1: Malformed Token Formats
print("\n--- Test 1: Malformed Token Handling ---")
malformed_tokens = [
    "",
    "invalid",
    "Bearer ",
    "1|",
    "|token",
    "1|" + "a" * 1000,  # Very long token
    "1|<script>alert(1)</script>",  # XSS in token
    "1|'; DROP TABLE users; --",  # SQLi in token
    "../../../etc/passwd",  # Path traversal
    "null",
    "undefined",
]

for token in malformed_tokens:
    try:
        response = requests.get(
            f"{base_url}/user",
            headers={
                "Authorization": f"Bearer {token}",
                "Accept": "application/json"
            }
        )
        
        if response.status_code == 401:
            results.append(("PASS", f"Malformed token rejected: '{token[:30]}...'"))
        else:
            results.append(("WARN", f"Token '{token[:30]}...' got {response.status_code}"))
            
    except Exception as e:
        results.append(("ERROR", f"Token test failed: {e}"))

passed_count = sum(1 for r in results if r[0] == "PASS")
print(f"✅ {passed_count}/{len(malformed_tokens)} malformed tokens properly rejected")

# Test 2: Token Reuse After Logout (requires fresh token)
print("\n--- Test 2: Token Invalidation Check ---")
try:
    # First, verify the valid token works
    response = requests.get(
        f"{base_url}/user",
        headers={
            "Authorization": f"Bearer {valid_token}",
            "Accept": "application/json"
        }
    )
    
    if response.status_code == 200:
        print("✅ Valid token authentication works")
    else:
        print(f"⚠️  Valid token returned: {response.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 3: Brute Force Protection (Login)
print("\n--- Test 3: Login Brute Force Protection ---")
attempts = 0
rate_limited = False

for i in range(15):
    try:
        response = requests.post(
            f"{base_url}/login",
            headers={"Accept": "application/json", "Content-Type": "application/json"},
            json={"email": "bruteforce@test.com", "password": f"wrong{i}"}
        )
        attempts += 1
        
        if response.status_code == 429:
            print(f"✅ PASSED: Rate limit triggered after {attempts} attempts")
            rate_limited = True
            break
            
    except Exception as e:
        pass

if not rate_limited:
    print(f"⚠️  Rate limit not triggered after {attempts} attempts")
    # This might be expected if threshold is higher

# Test 4: Password Reset Rate Limiting
print("\n--- Test 4: Password Reset Rate Limiting ---")
reset_attempts = 0
reset_limited = False

for i in range(10):
    try:
        response = requests.post(
            f"{base_url}/forgot-password",
            headers={"Accept": "application/json", "Content-Type": "application/json"},
            json={"email": f"test{i}@bruteforce.com"}
        )
        reset_attempts += 1
        
        if response.status_code == 429:
            print(f"✅ PASSED: Password reset rate limited after {reset_attempts} attempts")
            reset_limited = True
            break
            
    except Exception as e:
        pass

if not reset_limited:
    print(f"⚠️  Password reset not rate limited after {reset_attempts} attempts")

# Test 5: User Enumeration via Login
print("\n--- Test 5: User Enumeration Prevention ---")
try:
    # Test with existing user format
    response_existing = requests.post(
        f"{base_url}/login",
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        json={"email": "admin@example.com", "password": "wrongpassword"}
    )
    
    # Test with non-existing user
    response_nonexisting = requests.post(
        f"{base_url}/login",
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        json={"email": "nonexistent12345@example.com", "password": "wrongpassword"}
    )
    
    # Check if responses are similar (timing attack prevention)
    if response_existing.status_code == response_nonexisting.status_code:
        print("✅ PASSED: Same response code for existing/non-existing users")
    else:
        print(f"⚠️  Different responses: {response_existing.status_code} vs {response_nonexisting.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 6: JWT/Token Signature Tampering
print("\n--- Test 6: Token Tampering Detection ---")
try:
    # Try modifying the token hash
    tampered_token = valid_token[:-5] + "XXXXX"
    
    response = requests.get(
        f"{base_url}/user",
        headers={
            "Authorization": f"Bearer {tampered_token}",
            "Accept": "application/json"
        }
    )
    
    if response.status_code == 401:
        print("✅ PASSED: Tampered token rejected")
    else:
        print(f"❌ FAILED: Tampered token accepted ({response.status_code})")
        all_passed = False
        
except Exception as e:
    print(f"ERROR: {e}")
    all_passed = False

# Test 7: Authorization Header Injection
print("\n--- Test 7: Header Injection Prevention ---")
try:
    response = requests.get(
        f"{base_url}/user",
        headers={
            "Authorization": f"Bearer {valid_token}\r\nX-Injected: malicious",
            "Accept": "application/json"
        }
    )
    
    # Should either work normally or reject - but not execute injection
    if response.status_code in [200, 401, 400]:
        print(f"✅ Header injection handled safely ({response.status_code})")
    else:
        print(f"⚠️  Unexpected response: {response.status_code}")
        
except Exception as e:
    # Connection errors from malformed headers are expected
    print("✅ Header injection blocked at transport level")

print("\n" + "=" * 60)
if all_passed:
    print("✅ All Authentication Security Tests Passed!")
else:
    print("⚠️  Some Authentication Tests Need Review")
print("=" * 60)

sys.exit(0 if all_passed else 1)
