#!/usr/bin/env python3
"""
WebSocket (Reverb) Security Test
Tests WebSocket channel authorization via the broadcasting auth endpoint
Since websockets library may not be available, we test via HTTP auth endpoints
"""

import requests
import json
import sys
import time

# Configuration
API_BASE = "http://localhost:8000/api"
TOKEN = "1|rIChykfSoXL9rQ1eFpLzuLSSVlRqEuP42T2GYH6I77f4a980"
ATTACKER_TOKEN = "invalid-token-12345"

HEADERS = {
    "Authorization": f"Bearer {TOKEN}",
    "Accept": "application/json",
    "Content-Type": "application/json"
}

HEADERS_ATTACKER = {
    "Authorization": f"Bearer {ATTACKER_TOKEN}",
    "Accept": "application/json",
    "Content-Type": "application/json"
}

print("=" * 60)
print("WebSocket (Reverb) Security Test")
print("=" * 60)

all_passed = True


def test_auth_endpoint_exists():
    """Test that the broadcasting auth endpoint exists."""
    print("\n--- Test 1: Broadcasting Auth Endpoint ---")
    try:
        response = requests.post(
            f"{API_BASE}/broadcasting/auth",
            headers=HEADERS,
            json={"socket_id": "12345.67890", "channel_name": "private-test"}
        )
        
        # Should get 200 or 403, not 404
        if response.status_code != 404:
            print(f"✅ PASSED: Auth endpoint exists (Status: {response.status_code})")
            return True
        else:
            print("❌ FAILED: Auth endpoint not found")
            return False
            
    except Exception as e:
        print(f"ERROR: {e}")
        return False


def test_private_channel_requires_auth():
    """Test that private channels require authentication."""
    global all_passed
    print("\n--- Test 2: Private Channel Auth Required ---")
    try:
        # Try without authentication
        response = requests.post(
            f"{API_BASE}/broadcasting/auth",
            headers={"Accept": "application/json", "Content-Type": "application/json"},
            json={"socket_id": "12345.67890", "channel_name": "private-user.fake-id"}
        )
        
        if response.status_code == 401:
            print("✅ PASSED: Unauthenticated request rejected (401)")
        elif response.status_code == 403:
            print("✅ PASSED: Unauthorized request rejected (403)")
        else:
            print(f"⚠️  Response: {response.status_code}")
            
    except Exception as e:
        print(f"ERROR: {e}")
        all_passed = False


def test_private_channel_user_isolation():
    """Test that users can't subscribe to other users' private channels."""
    global all_passed
    print("\n--- Test 3: User Channel Isolation ---")
    try:
        # Authenticated user trying to access another user's channel
        response = requests.post(
            f"{API_BASE}/broadcasting/auth",
            headers=HEADERS,
            json={
                "socket_id": "12345.67890",
                "channel_name": "private-user.other-user-public-id"
            }
        )
        
        if response.status_code == 403:
            print("✅ PASSED: Access to other user's channel denied (403)")
        elif response.status_code == 401:
            print("✅ PASSED: Auth rejected (401)")
        elif response.status_code == 200:
            print("⚠️  Access granted - verify if this is expected behavior")
        else:
            print(f"ℹ️  Response: {response.status_code}")
            
    except Exception as e:
        print(f"ERROR: {e}")


def test_presence_channel_auth():
    """Test presence channel authorization."""
    global all_passed
    print("\n--- Test 4: Presence Channel Auth ---")
    try:
        response = requests.post(
            f"{API_BASE}/broadcasting/auth",
            headers=HEADERS,
            json={
                "socket_id": "12345.67890",
                "channel_name": "presence-online-users"
            }
        )
        
        if response.status_code == 200:
            data = response.json()
            if "auth" in data:
                print("✅ PASSED: Presence channel auth successful")
                # Check that channel_data includes user info
                if "channel_data" in data:
                    print("  ✅ Channel data included")
            else:
                print("⚠️  Response missing auth signature")
        elif response.status_code in [401, 403]:
            print(f"ℹ️  Presence auth denied ({response.status_code}) - may need specific permissions")
        else:
            print(f"ℹ️  Response: {response.status_code}")
            
    except Exception as e:
        print(f"ERROR: {e}")


def test_chat_channel_authorization():
    """Test chat channel access control."""
    global all_passed
    print("\n--- Test 5: Chat Channel Authorization ---")
    try:
        # Try to access a DM channel we shouldn't have access to
        response = requests.post(
            f"{API_BASE}/broadcasting/auth",
            headers=HEADERS,
            json={
                "socket_id": "12345.67890",
                "channel_name": "private-dm.FAKE-CHAT-ID-12345"
            }
        )
        
        if response.status_code == 403:
            print("✅ PASSED: Unauthorized chat channel access denied")
        elif response.status_code == 401:
            print("✅ PASSED: Auth rejected")
        elif response.status_code == 200:
            print("⚠️  Access granted - verify chat authorization logic")
        else:
            print(f"ℹ️  Response: {response.status_code}")
            
    except Exception as e:
        print(f"ERROR: {e}")


def test_invalid_channel_format():
    """Test handling of malformed channel names."""
    global all_passed
    print("\n--- Test 6: Invalid Channel Format Handling ---")
    
    invalid_channels = [
        "",
        "invalid",
        "private-",
        "presence-",
        "../../../etc/passwd",
        "private-<script>alert(1)</script>",
        "private-" + "A" * 1000,  # Very long channel name
    ]
    
    handled = 0
    for channel in invalid_channels:
        try:
            response = requests.post(
                f"{API_BASE}/broadcasting/auth",
                headers=HEADERS,
                json={"socket_id": "12345.67890", "channel_name": channel}
            )
            
            if response.status_code in [400, 403, 422]:
                handled += 1
            elif response.status_code == 200:
                print(f"  ⚠️  Channel '{channel[:30]}...' was authorized")
                
        except Exception:
            handled += 1
    
    print(f"✅ {handled}/{len(invalid_channels)} invalid channels handled properly")


def test_socket_id_validation():
    """Test socket_id parameter validation."""
    global all_passed
    print("\n--- Test 7: Socket ID Validation ---")
    
    invalid_socket_ids = [
        "",
        "invalid",
        "12345",  # Missing second part
        "'; DROP TABLE users; --",  # SQL injection
        "<script>alert(1)</script>",  # XSS
    ]
    
    handled = 0
    for socket_id in invalid_socket_ids:
        try:
            response = requests.post(
                f"{API_BASE}/broadcasting/auth",
                headers=HEADERS,
                json={"socket_id": socket_id, "channel_name": "private-test"}
            )
            
            if response.status_code in [400, 403, 422]:
                handled += 1
            elif response.status_code == 200:
                print(f"  ⚠️  Socket ID '{socket_id}' was accepted")
                
        except Exception:
            handled += 1
    
    print(f"✅ {handled}/{len(invalid_socket_ids)} invalid socket IDs handled properly")


def test_rate_limiting():
    """Test rate limiting on auth endpoint."""
    global all_passed
    print("\n--- Test 8: Auth Endpoint Rate Limiting ---")
    
    requests_made = 0
    rate_limited = False
    
    for i in range(30):
        try:
            response = requests.post(
                f"{API_BASE}/broadcasting/auth",
                headers=HEADERS,
                json={"socket_id": "12345.67890", "channel_name": "private-test"}
            )
            requests_made += 1
            
            if response.status_code == 429:
                print(f"✅ PASSED: Rate limited after {requests_made} requests")
                rate_limited = True
                break
                
        except Exception:
            break
    
    if not rate_limited:
        print(f"ℹ️  No rate limit hit after {requests_made} requests")


def main():
    test_auth_endpoint_exists()
    test_private_channel_requires_auth()
    test_private_channel_user_isolation()
    test_presence_channel_auth()
    test_chat_channel_authorization()
    test_invalid_channel_format()
    test_socket_id_validation()
    test_rate_limiting()
    
    print("\n" + "=" * 60)
    if all_passed:
        print("✅ All WebSocket Security Tests Passed!")
    else:
        print("⚠️  Some WebSocket Tests Need Review")
    print("=" * 60)
    
    sys.exit(0 if all_passed else 1)


if __name__ == "__main__":
    main()
