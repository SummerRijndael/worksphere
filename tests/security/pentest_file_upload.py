#!/usr/bin/env python3
"""
File Upload Security Pentest Script
Tests for file upload vulnerabilities including MIME spoofing and path traversal
"""

import requests
import sys
import os
import io

base_url = "http://localhost:8000/api"
token = "1|rIChykfSoXL9rQ1eFpLzuLSSVlRqEuP42T2GYH6I77f4a980"

headers = {
    "Authorization": f"Bearer {token}",
    "Accept": "application/json"
}

print("=" * 60)
print("File Upload Security Pentest")
print("=" * 60)

all_passed = True

# Test 1: Dangerous Extension Upload
print("\n--- Test 1: Dangerous Extension Blocking ---")
dangerous_extensions = [
    ("test.php", b"<?php echo 'pwned'; ?>", "application/x-php"),
    ("test.exe", b"MZ\x90\x00", "application/x-msdownload"),
    ("test.sh", b"#!/bin/bash\necho pwned", "application/x-sh"),
    ("test.bat", b"@echo off\necho pwned", "application/x-msdos-program"),
    ("test.jsp", b"<%= 'pwned' %>", "application/x-jsp"),
    ("test.aspx", b"<%@ Page %>", "application/x-aspx"),
]

blocked_count = 0
for filename, content, mime in dangerous_extensions:
    try:
        files = {"file": (filename, io.BytesIO(content), mime)}
        response = requests.post(
            f"{base_url}/user/avatar",
            headers=headers,
            files=files
        )
        
        if response.status_code in [422, 400, 415]:
            blocked_count += 1
        else:
            print(f"⚠️  {filename}: Got {response.status_code} - may need review")
            
    except Exception as e:
        print(f"ERROR testing {filename}: {e}")

print(f"✅ {blocked_count}/{len(dangerous_extensions)} dangerous extensions blocked")
if blocked_count < len(dangerous_extensions):
    all_passed = False

# Test 2: Double Extension Attack
print("\n--- Test 2: Double Extension Prevention ---")
double_extensions = [
    "image.php.jpg",
    "document.exe.pdf",
    "script.sh.png",
    "code.jsp.gif",
]

blocked_double = 0
for filename in double_extensions:
    try:
        # Create fake image content
        content = b'\x89PNG\r\n\x1a\n' + b'\x00' * 100  # PNG header
        files = {"file": (filename, io.BytesIO(content), "image/png")}
        
        response = requests.post(
            f"{base_url}/user/avatar",
            headers=headers,
            files=files
        )
        
        if response.status_code in [422, 400]:
            blocked_double += 1
        elif response.status_code == 200:
            print(f"⚠️  {filename}: Accepted - check if sanitized on server")
        else:
            print(f"ℹ️  {filename}: {response.status_code}")
            
    except Exception as e:
        print(f"ERROR testing {filename}: {e}")

print(f"ℹ️  {blocked_double}/{len(double_extensions)} double extensions explicitly blocked")

# Test 3: MIME Type Spoofing
print("\n--- Test 3: MIME Type Spoofing Prevention ---")
try:
    # Create PHP content but claim it's an image
    php_content = b"<?php system($_GET['cmd']); ?>"
    
    files = {"file": ("innocent.jpg", io.BytesIO(php_content), "image/jpeg")}
    response = requests.post(
        f"{base_url}/user/avatar",
        headers=headers,
        files=files
    )
    
    if response.status_code in [422, 400]:
        print("✅ PASSED: MIME spoofing detected (file content mismatch)")
    elif response.status_code == 200:
        print("⚠️  File accepted - verify server validates magic bytes")
    else:
        print(f"ℹ️  Response: {response.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")

# Test 4: Path Traversal in Filename
print("\n--- Test 4: Path Traversal Prevention ---")
traversal_names = [
    "../../../etc/passwd",
    "..\\..\\..\\windows\\system32\\config\\sam",
    "....//....//....//etc/passwd",
    "..%2f..%2f..%2fetc%2fpasswd",
    "/etc/passwd",
    "C:\\Windows\\System32\\config\\SAM",
]

traversal_blocked = 0
for filename in traversal_names:
    try:
        content = b'\x89PNG\r\n\x1a\n' + b'\x00' * 100
        files = {"file": (filename, io.BytesIO(content), "image/png")}
        
        response = requests.post(
            f"{base_url}/user/avatar",
            headers=headers,
            files=files
        )
        
        if response.status_code in [422, 400]:
            traversal_blocked += 1
        elif response.status_code == 200:
            # Check if filename was sanitized
            try:
                result = response.json()
                stored_name = result.get("file_name", result.get("name", ""))
                if "/" not in stored_name and "\\" not in stored_name and ".." not in stored_name:
                    traversal_blocked += 1
                    print(f"✅ {filename[:30]}: Sanitized to safe name")
                else:
                    print(f"⚠️  {filename[:30]}: May not be sanitized")
            except:
                pass
        else:
            print(f"ℹ️  {filename[:30]}: {response.status_code}")
            
    except Exception as e:
        pass

print(f"✅ {traversal_blocked}/{len(traversal_names)} path traversal attempts handled")

# Test 5: File Size Limits
print("\n--- Test 5: File Size Limits ---")
try:
    # Create oversized file (10MB)
    large_content = b'\x89PNG\r\n\x1a\n' + (b'\x00' * (10 * 1024 * 1024))
    
    files = {"file": ("large_image.png", io.BytesIO(large_content), "image/png")}
    response = requests.post(
        f"{base_url}/user/avatar",
        headers=headers,
        files=files
    )
    
    if response.status_code in [422, 413, 400]:
        print("✅ PASSED: Large file rejected")
    else:
        print(f"ℹ️  Large file response: {response.status_code}")
        
except Exception as e:
    print(f"ERROR: {e}")

# Test 6: Null Byte Injection
print("\n--- Test 6: Null Byte Injection ---")
try:
    null_byte_names = [
        "image.php\x00.jpg",
        "script\x00.png",
    ]
    
    for filename in null_byte_names:
        content = b'\x89PNG\r\n\x1a\n' + b'\x00' * 100
        files = {"file": (filename, io.BytesIO(content), "image/png")}
        
        response = requests.post(
            f"{base_url}/user/avatar",
            headers=headers,
            files=files
        )
        
        if response.status_code in [422, 400]:
            print(f"✅ Null byte in filename rejected")
        elif response.status_code == 200:
            print(f"ℹ️  Accepted - verify null bytes stripped server-side")
        else:
            print(f"ℹ️  Response: {response.status_code}")
            
except Exception as e:
    # Null bytes often cause issues at transport level
    print(f"✅ Null byte likely blocked at transport level")

print("\n" + "=" * 60)
if all_passed:
    print("✅ All File Upload Security Tests Passed!")
else:
    print("⚠️  Some File Upload Tests Need Review")
print("=" * 60)

sys.exit(0 if all_passed else 1)
